@page "/Index"
@inject CUENSA.Repositories.Interfaces.ICommon CommonService

<PageTitle>Dashboard - Cuentas de Salud</PageTitle>

<div class="container mt-4">
    <h3 class="mb-4 fw-bold text-center">📊 Dashboard de Cuentas de Salud</h3>

    <!-- Tarjetas -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <Card class="shadow-sm border-0 bg-light">
                <CardBody class="text-center">
                    <h6 class="text-muted">Total Instalaciones</h6>
                    <h2 class="fw-bold text-primary">@TotalInstalaciones</h2>
                </CardBody>
            </Card>
        </div>
        <div class="col-md-3">
            <Card class="shadow-sm border-0 bg-light">
                <CardBody class="text-center">
                    <h6 class="text-muted">Clasificaciones SHA</h6>
                    <h2 class="fw-bold text-success">@TotalClasificaciones</h2>
                </CardBody>
            </Card>
        </div>
        <div class="col-md-3">
            <Card class="shadow-sm border-0 bg-light">
                <CardBody class="text-center">
                    <h6 class="text-muted">Provincias</h6>
                    <h2 class="fw-bold text-warning">@TotalProvincias</h2>
                </CardBody>
            </Card>
        </div>
        <div class="col-md-3">
            <Card class="shadow-sm border-0 bg-light">
                <CardBody class="text-center">
                    <h6 class="text-muted">Registros Totales</h6>
                    <h2 class="fw-bold text-danger">@TotalRegistros</h2>
                </CardBody>
            </Card>
        </div>
    </div>

    <!-- Gráficas -->
    <div class="row g-4">
        <div class="col-md-6">
            <Card class="shadow-sm border-0">
                <CardHeader class="fw-bold bg-primary text-white">
                    Instalaciones por Provincia
                </CardHeader>
                <CardBody>
                    <BlazorBootstrap.BarChart Data="@BarChartData" />
                </CardBody>
            </Card>
        </div>
        <div class="col-md-6">
            <Card class="shadow-sm border-0">
                <CardHeader class="fw-bold bg-success text-white">
                    Distribución por Clasificación SHA
                </CardHeader>
                <CardBody>
                    <BlazorBootstrap.PieChart Data="@PieChartData" />
                </CardBody>
            </Card>
        </div>
    </div>
</div>

@code {
    // Gráficas
    private ChartData BarChartData = default!;
    private ChartData PieChartData = default!;

    // Totales
    private int TotalInstalaciones;
    private int TotalClasificaciones;
    private int TotalProvincias;
    private int TotalRegistros;

    protected override async Task OnInitializedAsync()
    {
        TotalInstalaciones = await CommonService.GetTotalInstalacionesAsync();
        TotalClasificaciones = await CommonService.GetTotalClasificacionesAsync();
        TotalProvincias = await CommonService.GetTotalProvinciasAsync();
        TotalRegistros = await CommonService.GetTotalRegistrosAsync();

        // Instalaciones por provincia
        var instalacionesPorProvincia = await CommonService.GetInstalacionesPorProvinciaAsync();
        BarChartData = new ChartData
        {
            Labels = instalacionesPorProvincia.Keys.ToList(),
            Datasets = new List<IChartDataset>
            {
                new BarChartDataset
                {
                    Label = "Instalaciones",
                    Data = instalacionesPorProvincia.Values.Select(v => (double?)v).ToList(),
                    BackgroundColor = new List<string>
                    {
                        "#007bff", "#28a745", "#ffc107", "#dc3545", "#6f42c1"
                    }
                }
            }
        };

        // Clasificación SHA
        var clasificacionesSha = await CommonService.GetClasificacionesShaAsync();
        PieChartData = new ChartData
        {
            Labels = clasificacionesSha.Keys.ToList(),
            Datasets = new List<IChartDataset>
            {
                new PieChartDataset
                {
                    Label = "Clasificación SHA",
                    Data = clasificacionesSha.Values.Select(v => (double?)v).ToList(),
                    BackgroundColor = new List<string>
                    {
                        "#17a2b8", "#ffc107", "#28a745", "#dc3545"
                    }
                }
            }
        };
    }
}
